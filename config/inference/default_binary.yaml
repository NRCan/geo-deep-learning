# @package _global_
inference:
  raw_data_csv:  # TODO: what to do with this param?
  input_stac_item: tests/data/spacenet/SpaceNet_AOI_2_Las_Vegas-056155973080_01_P001-WV03_ci.json
  root_dir: data/inference
  checkpoint_dir: ${general.save_weights_dir}  # (string, optional): directory in which to save the object if url
  output_name: SpaceNet_AOI_2_Las_Vegas-056155973080_01_P001-WV03_pred # name of output file to write in root.
  state_dict_path: ${general.save_weights_dir}/
  download_data: True  # if True, will download local copy of imagery and infer from this copy rather than from web
                        # if network bandwidth is good, no need to download as only windows are downloaded to infer
  save_heatmap: True  # saves a heatmap to root_dir/{output_name}_heatmap.tif
  heatmap_threshold: 50

  # GPU parameters
  gpu: 1  # Number of gpus to use.
  max_used_perc: ${training.max_used_perc}  # If RAM usage of detected GPU exceeds this percentage, it will be ignored
  max_used_ram: ${training.max_used_ram}  # If GPU's usage exceeds this percentage, it will be ignored

  batch_size: 2 # if empty, will be calculated automatically to fill "auto_batch_size_threshold" % of GPU Ram
  chunk_size: 64 # Defaults to 512
  auto_batch_size_threshold:
  enhance_clip_limit: # if empty, will skip enhancement transform
  test_transforms:
    _target_: torchvision.transforms.Compose
    transforms:
      [{'_target_': inference.InferenceDataModule.pad, size: 16, mode: 'reflect'},
      {'_target_': inference.InferenceDataModule.enhance, clip_limit: '${inference.enhance_clip_limit}'},
      {'_target_': inference.InferenceDataModule.preprocess}]

  # Test-time augmentation tranforms. See: https://github.com/qubvel/ttach#transforms
  tta_transforms:  # transform object by hydra's instantiate() method
    _target_: ttach.SegmentationTTAWrapper
    transforms:
      _target_: ttach.Compose
      transforms: [{_target_: ttach.HorizontalFlip}]  # Alternative: tta.aliases.d4_transform()
    merge_mode: max  # Test time augmentation merge mode. See: https://github.com/qubvel/ttach#merge-modes
